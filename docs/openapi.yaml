openapi: 3.0.3
info:
  title: Cloud Assessment MVP API
  version: 0.1.0
  description: |
    AWS理解度テストWebアプリMVPのAPI定義。
    認証は署名付きHTTP-only Cookie（session）を利用する。
servers:
  - url: http://localhost:3000

paths:
  /api/auth/signup:
    post:
      tags: [Auth]
      summary: サインアップ
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/SignupRequest"
      responses:
        "201":
          description: 作成成功
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/AuthSuccessResponse"
        "400":
          $ref: "#/components/responses/BadRequest"
        "409":
          description: メール重複
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

  /api/auth/login:
    post:
      tags: [Auth]
      summary: ログイン
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/LoginRequest"
      responses:
        "200":
          description: ログイン成功
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/AuthSuccessResponse"
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          description: 認証失敗
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "429":
          description: 試行回数超過（レート制限）
          headers:
            Retry-After:
              description: 次回試行までの待機秒数
              schema:
                type: integer
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

  /api/auth/logout:
    post:
      tags: [Auth]
      summary: ログアウト
      security:
        - cookieAuth: []
      responses:
        "200":
          description: ログアウト成功
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/MessageResponse"
        "401":
          $ref: "#/components/responses/Unauthorized"

  /api/attempts/create:
    post:
      tags: [Attempts]
      summary: Attempt作成
      security:
        - cookieAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/CreateAttemptRequest"
      responses:
        "201":
          description: 作成成功
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/CreateAttemptResponse"
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"

  /api/attempts/{attemptId}/answer:
    post:
      tags: [Attempts]
      summary: 回答保存
      security:
        - cookieAuth: []
      parameters:
        - name: attemptId
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/AnswerAttemptRequest"
      responses:
        "200":
          description: 保存成功
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/AnswerAttemptResponse"
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          $ref: "#/components/responses/Forbidden"
        "404":
          $ref: "#/components/responses/NotFound"

  /api/attempts/{attemptId}/finalize:
    post:
      tags: [Attempts]
      summary: 採点確定
      security:
        - cookieAuth: []
      parameters:
        - name: attemptId
          in: path
          required: true
          schema:
            type: string
      responses:
        "200":
          description: 採点成功
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/FinalizeAttemptResponse"
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          $ref: "#/components/responses/Forbidden"
        "404":
          $ref: "#/components/responses/NotFound"

  /api/questions/categories:
    get:
      tags: [Questions]
      summary: カテゴリ一覧取得
      description: Seedされた問題のカテゴリ一覧を返す。/select画面のカテゴリ選択UIで使用。
      responses:
        "200":
          description: 取得成功
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/CategoriesResponse"

  /api/attempts/{attemptId}:
    get:
      tags: [Attempts]
      summary: Attempt詳細取得
      description: 指定Attemptの問題一覧・進捗・結果を返す。/quiz/[attemptId]画面で使用。
      security:
        - cookieAuth: []
      parameters:
        - name: attemptId
          in: path
          required: true
          schema:
            type: string
      responses:
        "200":
          description: 取得成功
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/AttemptDetailResponse"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          $ref: "#/components/responses/Forbidden"
        "404":
          $ref: "#/components/responses/NotFound"

  /api/me:
    get:
      tags: [Me]
      summary: ログインユーザー情報取得
      security:
        - cookieAuth: []
      responses:
        "200":
          description: 取得成功
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/MeResponse"
        "401":
          $ref: "#/components/responses/Unauthorized"

  /api/me/attempts:
    get:
      tags: [Me]
      summary: 受験履歴一覧取得
      description: ログインユーザーの過去Attempt一覧（日時/条件/スコア）を返す。
      security:
        - cookieAuth: []
      responses:
        "200":
          description: 取得成功
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/MyAttemptsResponse"
        "401":
          $ref: "#/components/responses/Unauthorized"

  /api/me/attempts/{attemptId}:
    get:
      tags: [Me]
      summary: 受験結果詳細取得
      description: 特定Attemptの詳細結果（間違い問題・解説含む）を返す。
      security:
        - cookieAuth: []
      parameters:
        - name: attemptId
          in: path
          required: true
          schema:
            type: string
      responses:
        "200":
          description: 取得成功
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/MyAttemptDetailResponse"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          $ref: "#/components/responses/Forbidden"
        "404":
          $ref: "#/components/responses/NotFound"

  /api/me/attempts/{attemptId}/deliver-notion:
    post:
      tags: [Me]
      summary: Notionへ受験結果を送信
      description: |
        指定Attempt（完了済み）の設問を Notion Database へ送信する（設問単位で1行作成）。
        Notion DB は以下の8カラム構成を前提とする。
        - `attempt id` (Text)
        - `category` (Text)
        - `level` (Number)
        - `questionText` (Text)
        - `selectedChoice` (Text)
        - `answerChoice` (Text)
        - `isCorrect` (Checkbox)
        - `explanation` (Text)

        なお Notion Database の仕様上、別途 Title 列が1つ必要。
        その列名は `NOTION_TITLE_PROPERTY_NAME`（デフォルト: `Name`）で指定する。

        冪等性は `attempt id` + `category` + `level` + `questionText` の組み合わせで判定し、
        既存の設問行は再作成しない。全設問が既存の場合は `duplicate: true` を返す。
      security:
        - cookieAuth: []
      parameters:
        - name: attemptId
          in: path
          required: true
          schema:
            type: string
      responses:
        "200":
          description: 送信成功または冪等スキップ
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/NotionDeliveryResponse"
              examples:
                sent:
                  summary: 新規送信
                  value:
                    status: sent
                    attempts: 1
                    duplicate: false
                duplicate:
                  summary: 全設問が既存で新規作成なし
                  value:
                    status: sent
                    attempts: 1
                    duplicate: true
                skipped:
                  summary: 設定不足で送信スキップ
                  value:
                    status: skipped
                    reason: missing_config
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          $ref: "#/components/responses/Forbidden"
        "404":
          $ref: "#/components/responses/NotFound"
        "502":
          description: 外部連携エラー
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/NotionDeliveryResponse"
              examples:
                failed:
                  value:
                    status: failed
                    attempts: 3
                    errorMessage: "notion create page failed: status=503"

components:
  securitySchemes:
    cookieAuth:
      type: apiKey
      in: cookie
      name: session

  responses:
    BadRequest:
      description: バリデーションエラー
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/ErrorResponse"
    Unauthorized:
      description: 未認証
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/ErrorResponse"
    Forbidden:
      description: 権限不足（所有者不一致など）
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/ErrorResponse"
    NotFound:
      description: 対象が存在しない
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/ErrorResponse"

  schemas:
    MessageResponse:
      type: object
      required: [message]
      properties:
        message:
          type: string

    ErrorResponse:
      type: object
      required: [message]
      properties:
        message:
          type: string

    SignupRequest:
      type: object
      required: [email, password]
      properties:
        email:
          type: string
          format: email
        password:
          type: string
          minLength: 8
          description: 英大文字・英小文字・数字を各1文字以上含む

    LoginRequest:
      type: object
      required: [email, password]
      properties:
        email:
          type: string
          format: email
        password:
          type: string

    AuthSuccessResponse:
      type: object
      required: [message]
      properties:
        message:
          type: string
          example: ok

    CreateAttemptRequest:
      type: object
      required: [categories, level, numQuestions]
      properties:
        categories:
          type: array
          items:
            type: string
          minItems: 1
        level:
          type: integer
          enum: [1, 2, 3]
        numQuestions:
          type: integer
          minimum: 1

    CreateAttemptResponse:
      type: object
      required: [attemptId]
      properties:
        attemptId:
          type: string

    AnswerAttemptRequest:
      type: object
      required: [attemptQuestionId, selectedIndex]
      properties:
        attemptQuestionId:
          type: string
        selectedIndex:
          type: integer
          minimum: 0

    AnswerAttemptResponse:
      type: object
      required: [message]
      properties:
        message:
          type: string
          example: saved

    CategoryBreakdownItem:
      type: object
      required: [correct, total, percent]
      properties:
        correct:
          type: integer
        total:
          type: integer
        percent:
          type: number
          format: float

    FinalizeAttemptResponse:
      type: object
      required: [overallPercent, categoryBreakdown]
      properties:
        overallPercent:
          type: number
          format: float
        categoryBreakdown:
          type: object
          additionalProperties:
            $ref: "#/components/schemas/CategoryBreakdownItem"

    CategoriesResponse:
      type: object
      required: [categories]
      properties:
        categories:
          type: array
          items:
            type: string
          example: [VPC, EC2, S3, IAM, RDS, Lambda]

    AttemptQuestionItem:
      type: object
      required: [id, questionId, order, questionText, choices]
      properties:
        id:
          type: string
        questionId:
          type: string
        order:
          type: integer
        questionText:
          type: string
        choices:
          type: array
          items:
            type: string
        selectedIndex:
          type: integer
          nullable: true
        isCorrect:
          type: boolean
          nullable: true
        answerIndex:
          type: integer
          description: finalize後のみ返却
        explanation:
          type: string
          description: finalize後のみ返却
        category:
          type: string

    AttemptDetailResponse:
      type: object
      required: [id, status, filters, startedAt, questions]
      properties:
        id:
          type: string
        status:
          type: string
          enum: [IN_PROGRESS, COMPLETED]
        filters:
          type: object
        startedAt:
          type: string
          format: date-time
        completedAt:
          type: string
          format: date-time
          nullable: true
        questions:
          type: array
          items:
            $ref: "#/components/schemas/AttemptQuestionItem"
        result:
          $ref: "#/components/schemas/FinalizeAttemptResponse"
          nullable: true

    MeResponse:
      type: object
      required: [id, email]
      properties:
        id:
          type: string
        email:
          type: string
          format: email

    MyAttemptSummary:
      type: object
      required: [id, status, filters, startedAt]
      properties:
        id:
          type: string
        status:
          type: string
          enum: [IN_PROGRESS, COMPLETED]
        filters:
          type: object
        startedAt:
          type: string
          format: date-time
        completedAt:
          type: string
          format: date-time
          nullable: true
        overallPercent:
          type: number
          format: float
          nullable: true
          description: COMPLETED時のみ

    MyAttemptsResponse:
      type: object
      required: [attempts]
      properties:
        attempts:
          type: array
          items:
            $ref: "#/components/schemas/MyAttemptSummary"

    MyAttemptDetailResponse:
      type: object
      required: [id, status, filters, startedAt, questions, result]
      properties:
        id:
          type: string
        status:
          type: string
          enum: [IN_PROGRESS, COMPLETED]
        filters:
          type: object
        startedAt:
          type: string
          format: date-time
        completedAt:
          type: string
          format: date-time
          nullable: true
        questions:
          type: array
          items:
            $ref: "#/components/schemas/AttemptQuestionItem"
        result:
          $ref: "#/components/schemas/FinalizeAttemptResponse"

    NotionDeliveryResponse:
      type: object
      required: [status]
      properties:
        status:
          type: string
          enum: [sent, skipped, failed]
        attempts:
          type: integer
          description: 送信を試みた回数
        duplicate:
          type: boolean
          description: 対象設問がすべて既存で新規作成がなかった場合はtrue
        reason:
          type: string
          description: skipped時の理由
        errorMessage:
          type: string
          description: failed時のエラー内容
