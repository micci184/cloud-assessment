openapi: 3.0.3
info:
  title: Cloud Assessment MVP API
  version: 0.1.0
  description: |
    AWS理解度テストWebアプリMVPのAPI定義。
    認証は署名付きHTTP-only Cookie（session）を利用する。
servers:
  - url: http://localhost:3000

paths:
  /api/auth/signup:
    post:
      tags: [Auth]
      summary: サインアップ
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/SignupRequest'
      responses:
        '201':
          description: 作成成功
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AuthSuccessResponse'
        '400':
          $ref: '#/components/responses/BadRequest'
        '409':
          description: メール重複
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /api/auth/login:
    post:
      tags: [Auth]
      summary: ログイン
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/LoginRequest'
      responses:
        '200':
          description: ログイン成功
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AuthSuccessResponse'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          description: 認証失敗
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /api/auth/logout:
    post:
      tags: [Auth]
      summary: ログアウト
      security:
        - cookieAuth: []
      responses:
        '200':
          description: ログアウト成功
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/MessageResponse'
        '401':
          $ref: '#/components/responses/Unauthorized'

  /api/attempts/create:
    post:
      tags: [Attempts]
      summary: Attempt作成
      security:
        - cookieAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateAttemptRequest'
      responses:
        '201':
          description: 作成成功
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CreateAttemptResponse'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'

  /api/attempts/{attemptId}/answer:
    post:
      tags: [Attempts]
      summary: 回答保存
      security:
        - cookieAuth: []
      parameters:
        - name: attemptId
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/AnswerAttemptRequest'
      responses:
        '200':
          description: 保存成功
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AnswerAttemptResponse'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          $ref: '#/components/responses/NotFound'

  /api/attempts/{attemptId}/finalize:
    post:
      tags: [Attempts]
      summary: 採点確定
      security:
        - cookieAuth: []
      parameters:
        - name: attemptId
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: 採点成功
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/FinalizeAttemptResponse'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          $ref: '#/components/responses/NotFound'

components:
  securitySchemes:
    cookieAuth:
      type: apiKey
      in: cookie
      name: session

  responses:
    BadRequest:
      description: バリデーションエラー
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
    Unauthorized:
      description: 未認証
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
    Forbidden:
      description: 権限不足（所有者不一致など）
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
    NotFound:
      description: 対象が存在しない
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'

  schemas:
    MessageResponse:
      type: object
      required: [message]
      properties:
        message:
          type: string

    ErrorResponse:
      type: object
      required: [message]
      properties:
        message:
          type: string

    SignupRequest:
      type: object
      required: [email, password]
      properties:
        email:
          type: string
          format: email
        password:
          type: string
          minLength: 8

    LoginRequest:
      type: object
      required: [email, password]
      properties:
        email:
          type: string
          format: email
        password:
          type: string

    AuthSuccessResponse:
      type: object
      required: [message]
      properties:
        message:
          type: string
          example: ok

    CreateAttemptRequest:
      type: object
      required: [categories, level, numQuestions]
      properties:
        categories:
          type: array
          items:
            type: string
          minItems: 1
        level:
          type: integer
          enum: [1, 2, 3]
        numQuestions:
          type: integer
          minimum: 1

    CreateAttemptResponse:
      type: object
      required: [attemptId]
      properties:
        attemptId:
          type: string

    AnswerAttemptRequest:
      type: object
      required: [attemptQuestionId, selectedIndex]
      properties:
        attemptQuestionId:
          type: string
        selectedIndex:
          type: integer
          minimum: 0

    AnswerAttemptResponse:
      type: object
      required: [message]
      properties:
        message:
          type: string
          example: saved

    CategoryBreakdownItem:
      type: object
      required: [correct, total, percent]
      properties:
        correct:
          type: integer
        total:
          type: integer
        percent:
          type: number
          format: float

    FinalizeAttemptResponse:
      type: object
      required: [overallPercent, categoryBreakdown]
      properties:
        overallPercent:
          type: number
          format: float
        categoryBreakdown:
          type: object
          additionalProperties:
            $ref: '#/components/schemas/CategoryBreakdownItem'
