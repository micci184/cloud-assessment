openapi: 3.0.3
info:
  title: Cloud Assessment MVP API
  version: 0.1.0
  description: |
    AWS理解度テストWebアプリMVPのAPI定義。
    認証は署名付きHTTP-only Cookie（session）を利用する。
servers:
  - url: http://localhost:3000

paths:
  /api/auth/signup:
    post:
      tags: [Auth]
      summary: サインアップ
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/SignupRequest"
      responses:
        "201":
          description: 作成成功
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/AuthSuccessResponse"
        "400":
          $ref: "#/components/responses/BadRequest"
        "409":
          description: メール重複
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

  /api/auth/login:
    post:
      tags: [Auth]
      summary: ログイン
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/LoginRequest"
      responses:
        "200":
          description: ログイン成功
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/AuthSuccessResponse"
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          description: 認証失敗
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "429":
          description: 試行回数超過（レート制限）
          headers:
            Retry-After:
              description: 次回試行までの待機秒数
              schema:
                type: integer
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

  /api/auth/logout:
    post:
      tags: [Auth]
      summary: ログアウト
      security:
        - cookieAuth: []
      responses:
        "200":
          description: ログアウト成功
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/MessageResponse"
        "401":
          $ref: "#/components/responses/Unauthorized"

  /api/attempts/create:
    post:
      tags: [Attempts]
      summary: Attempt作成
      security:
        - cookieAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/CreateAttemptRequest"
      responses:
        "201":
          description: 作成成功
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/CreateAttemptResponse"
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"

  /api/attempts/{attemptId}/answer:
    post:
      tags: [Attempts]
      summary: 回答保存
      security:
        - cookieAuth: []
      parameters:
        - name: attemptId
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/AnswerAttemptRequest"
      responses:
        "200":
          description: 保存成功
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/AnswerAttemptResponse"
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          $ref: "#/components/responses/Forbidden"
        "404":
          $ref: "#/components/responses/NotFound"

  /api/attempts/{attemptId}/finalize:
    post:
      tags: [Attempts]
      summary: 採点確定
      security:
        - cookieAuth: []
      parameters:
        - name: attemptId
          in: path
          required: true
          schema:
            type: string
      responses:
        "200":
          description: 採点成功
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/FinalizeAttemptResponse"
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          $ref: "#/components/responses/Forbidden"
        "404":
          $ref: "#/components/responses/NotFound"

  /api/questions/categories:
    get:
      tags: [Questions]
      summary: カテゴリ一覧取得
      description: Seedされた問題のカテゴリ一覧を返す。/select画面のカテゴリ選択UIで使用。
      responses:
        "200":
          description: 取得成功
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/CategoriesResponse"

  /api/attempts/{attemptId}:
    get:
      tags: [Attempts]
      summary: Attempt詳細取得
      description: 指定Attemptの問題一覧・進捗・結果を返す。/quiz/[attemptId]画面で使用。
      security:
        - cookieAuth: []
      parameters:
        - name: attemptId
          in: path
          required: true
          schema:
            type: string
      responses:
        "200":
          description: 取得成功
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/AttemptDetailResponse"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          $ref: "#/components/responses/Forbidden"
        "404":
          $ref: "#/components/responses/NotFound"

  /api/me:
    get:
      tags: [Me]
      summary: ログインユーザー情報取得
      security:
        - cookieAuth: []
      responses:
        "200":
          description: 取得成功
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/MeResponse"
        "401":
          $ref: "#/components/responses/Unauthorized"

  /api/me/stats:
    get:
      tags: [Me]
      summary: 学習サマリー統計取得
      description: ログインユーザーの全期間・直近の学習サマリー統計を返す。
      security:
        - cookieAuth: []
      responses:
        "200":
          description: 取得成功
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/MeStatsResponse"
        "401":
          $ref: "#/components/responses/Unauthorized"

  /api/me/attempts:
    get:
      tags: [Me]
      summary: 受験履歴一覧取得
      description: ログインユーザーの過去Attempt一覧（日時/条件/スコア）を返す。
      security:
        - cookieAuth: []
      parameters:
        - name: page
          in: query
          required: false
          description: ページ番号（1始まり）
          schema:
            type: integer
            minimum: 1
            default: 1
        - name: pageSize
          in: query
          required: false
          description: 1ページあたり件数（最大50、デフォルト10）
          schema:
            type: integer
            minimum: 1
            maximum: 50
            default: 10
      responses:
        "200":
          description: 取得成功
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/MyAttemptsResponse"
        "401":
          $ref: "#/components/responses/Unauthorized"

  /api/me/attempts/{attemptId}:
    get:
      tags: [Me]
      summary: 受験結果詳細取得
      description: 特定Attemptの詳細結果（間違い問題・解説含む）を返す。
      security:
        - cookieAuth: []
      parameters:
        - name: attemptId
          in: path
          required: true
          schema:
            type: string
      responses:
        "200":
          description: 取得成功
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/MyAttemptDetailResponse"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          $ref: "#/components/responses/Forbidden"
        "404":
          $ref: "#/components/responses/NotFound"

  /api/me/attempts/{attemptId}/deliver-notion:
    get:
      tags: [Me]
      summary: Notion送信ジョブステータス取得
      description: 指定Attemptの最新Notion送信ジョブの進捗・結果を返す。
      security:
        - cookieAuth: []
      parameters:
        - name: attemptId
          in: path
          required: true
          schema:
            type: string
      responses:
        "200":
          description: 取得成功
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/NotionDeliveryJobStatusResponse"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          $ref: "#/components/responses/Forbidden"
        "404":
          $ref: "#/components/responses/NotFound"
    post:
      tags: [Me]
      summary: Notionへ受験結果を送信
      description: |
        指定Attempt（完了済み）のNotion送信ジョブをキュー投入する。
        送信進捗は `GET /api/me/attempts/{attemptId}/deliver-notion` で参照する。
      security:
        - cookieAuth: []
      parameters:
        - name: attemptId
          in: path
          required: true
          schema:
            type: string
      responses:
        "202":
          description: ジョブ受付または既存ジョブ進行中
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/NotionDeliveryJobStartResponse"
              examples:
                queued:
                  summary: 新規ジョブ受付
                  value:
                    status: queued
                    job:
                      id: cma2jobexample
                      totalQuestions: 10
                      processedQuestions: 0
                      successQuestions: 0
                      failedQuestions: 0
                      lastError: null
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          $ref: "#/components/responses/Forbidden"
        "404":
          $ref: "#/components/responses/NotFound"

components:
  securitySchemes:
    cookieAuth:
      type: apiKey
      in: cookie
      name: session

  responses:
    BadRequest:
      description: バリデーションエラー
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/ErrorResponse"
    Unauthorized:
      description: 未認証
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/ErrorResponse"
    Forbidden:
      description: 権限不足（所有者不一致など）
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/ErrorResponse"
    NotFound:
      description: 対象が存在しない
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/ErrorResponse"

  schemas:
    MessageResponse:
      type: object
      required: [message]
      properties:
        message:
          type: string

    ErrorResponse:
      type: object
      required: [message]
      properties:
        message:
          type: string

    SignupRequest:
      type: object
      required: [email, password]
      properties:
        email:
          type: string
          format: email
        password:
          type: string
          minLength: 8
          description: 英大文字・英小文字・数字を各1文字以上含む

    LoginRequest:
      type: object
      required: [email, password]
      properties:
        email:
          type: string
          format: email
        password:
          type: string

    AuthSuccessResponse:
      type: object
      required: [message]
      properties:
        message:
          type: string
          example: ok

    CreateAttemptRequest:
      type: object
      required: [categories, level, numQuestions]
      properties:
        categories:
          type: array
          items:
            type: string
          minItems: 1
        level:
          type: integer
          enum: [1, 2, 3]
        numQuestions:
          type: integer
          minimum: 1

    CreateAttemptResponse:
      type: object
      required: [attemptId]
      properties:
        attemptId:
          type: string

    AnswerAttemptRequest:
      type: object
      required: [attemptQuestionId, selectedIndex]
      properties:
        attemptQuestionId:
          type: string
        selectedIndex:
          type: integer
          minimum: 0

    AnswerAttemptResponse:
      type: object
      required: [message]
      properties:
        message:
          type: string
          example: saved

    CategoryBreakdownItem:
      type: object
      required: [correct, total, percent]
      properties:
        correct:
          type: integer
        total:
          type: integer
        percent:
          type: number
          format: float

    FinalizeAttemptResponse:
      type: object
      required: [overallPercent, categoryBreakdown]
      properties:
        overallPercent:
          type: number
          format: float
        categoryBreakdown:
          type: object
          additionalProperties:
            $ref: "#/components/schemas/CategoryBreakdownItem"

    CategoriesResponse:
      type: object
      required: [categories]
      properties:
        categories:
          type: array
          items:
            type: string
          example: [VPC, EC2, S3, IAM, RDS, Lambda]

    AttemptQuestionItem:
      type: object
      required: [id, questionId, order, questionText, choices]
      properties:
        id:
          type: string
        questionId:
          type: string
        order:
          type: integer
        questionText:
          type: string
        choices:
          type: array
          items:
            type: string
        selectedIndex:
          type: integer
          nullable: true
        isCorrect:
          type: boolean
          nullable: true
        answerIndex:
          type: integer
          description: finalize後のみ返却
        explanation:
          type: string
          description: finalize後のみ返却
        category:
          type: string

    AttemptDetailResponse:
      type: object
      required: [id, status, filters, startedAt, questions]
      properties:
        id:
          type: string
        status:
          type: string
          enum: [IN_PROGRESS, COMPLETED]
        filters:
          type: object
        startedAt:
          type: string
          format: date-time
        completedAt:
          type: string
          format: date-time
          nullable: true
        questions:
          type: array
          items:
            $ref: "#/components/schemas/AttemptQuestionItem"
        result:
          $ref: "#/components/schemas/FinalizeAttemptResponse"
          nullable: true

    MeResponse:
      type: object
      required: [id, email]
      properties:
        id:
          type: string
        email:
          type: string
          format: email

    WeeklyActivityItem:
      type: object
      required: [date, count]
      properties:
        date:
          type: string
          format: date
          example: "2026-02-26"
        count:
          type: integer
          minimum: 0

    CategoryProgressItem:
      type: object
      required: [category, total, correct, percent]
      properties:
        category:
          type: string
        total:
          type: integer
          minimum: 0
        correct:
          type: integer
          minimum: 0
        percent:
          type: number
          format: float

    MeStatsResponse:
      type: object
      required:
        [
          totalAttempts,
          averagePercent,
          recentAveragePercent,
          bestPercent,
          streakDays,
          totalAnswered,
          recent7DaysAnswered,
          weeklyActivity,
          activityHeatmap,
          categoryProgress,
        ]
      properties:
        totalAttempts:
          type: integer
          minimum: 0
        averagePercent:
          type: number
          format: float
        recentAveragePercent:
          type: number
          format: float
        bestPercent:
          type: number
          format: float
        streakDays:
          type: integer
          minimum: 0
        totalAnswered:
          type: integer
          minimum: 0
        recent7DaysAnswered:
          type: integer
          minimum: 0
        weeklyActivity:
          type: array
          items:
            $ref: "#/components/schemas/WeeklyActivityItem"
        activityHeatmap:
          type: array
          items:
            $ref: "#/components/schemas/WeeklyActivityItem"
        categoryProgress:
          type: array
          items:
            $ref: "#/components/schemas/CategoryProgressItem"

    MyAttemptSummary:
      type: object
      required: [id, status, filters, startedAt]
      properties:
        id:
          type: string
        status:
          type: string
          enum: [IN_PROGRESS, COMPLETED]
        filters:
          type: object
        startedAt:
          type: string
          format: date-time
        completedAt:
          type: string
          format: date-time
          nullable: true
        result:
          $ref: "#/components/schemas/FinalizeAttemptResponse"
          nullable: true
          description: COMPLETED時のみ

    MyAttemptsResponse:
      type: object
      required: [attempts, pagination, summary]
      properties:
        attempts:
          type: array
          items:
            $ref: "#/components/schemas/MyAttemptSummary"
        pagination:
          $ref: "#/components/schemas/PaginationMeta"
        summary:
          $ref: "#/components/schemas/MyAttemptsSummaryMeta"

    PaginationMeta:
      type: object
      required: [totalCount, totalPages, currentPage, pageSize]
      properties:
        totalCount:
          type: integer
          minimum: 0
        totalPages:
          type: integer
          minimum: 0
        currentPage:
          type: integer
          minimum: 1
        pageSize:
          type: integer
          minimum: 1

    MyAttemptsSummaryMeta:
      type: object
      required: [latestCompleted, latestInProgress]
      properties:
        latestCompleted:
          $ref: "#/components/schemas/MyAttemptSummary"
          nullable: true
        latestInProgress:
          $ref: "#/components/schemas/MyAttemptSummary"
          nullable: true

    MyAttemptDetailResponse:
      type: object
      required: [id, status, filters, startedAt, questions, result]
      properties:
        id:
          type: string
        status:
          type: string
          enum: [IN_PROGRESS, COMPLETED]
        filters:
          type: object
        startedAt:
          type: string
          format: date-time
        completedAt:
          type: string
          format: date-time
          nullable: true
        questions:
          type: array
          items:
            $ref: "#/components/schemas/AttemptQuestionItem"
        result:
          $ref: "#/components/schemas/FinalizeAttemptResponse"

    NotionDeliveryJob:
      type: object
      required:
        [id, totalQuestions, processedQuestions, successQuestions, failedQuestions]
      properties:
        id:
          type: string
        totalQuestions:
          type: integer
          minimum: 0
        processedQuestions:
          type: integer
          minimum: 0
        successQuestions:
          type: integer
          minimum: 0
        failedQuestions:
          type: integer
          minimum: 0
        startedAt:
          type: string
          format: date-time
          nullable: true
        finishedAt:
          type: string
          format: date-time
          nullable: true
        lastError:
          type: string
          nullable: true
        failedItems:
          type: array
          items:
            type: object
            required: [category, level, questionText, errorMessage]
            properties:
              category:
                type: string
              level:
                type: integer
              questionText:
                type: string
              errorMessage:
                type: string

    NotionDeliveryJobStartResponse:
      type: object
      required: [status, job]
      properties:
        status:
          type: string
          enum: [queued, in_progress]
        job:
          $ref: "#/components/schemas/NotionDeliveryJob"

    NotionDeliveryJobStatusResponse:
      type: object
      required: [status]
      properties:
        status:
          type: string
          enum: [idle, queued, in_progress, completed, completed_with_errors, failed]
        job:
          $ref: "#/components/schemas/NotionDeliveryJob"
          nullable: true
        message:
          type: string
          nullable: true

    NotionDeliveryResponse:
      type: object
      required: [status]
      properties:
        status:
          type: string
          enum: [sent, skipped, failed]
        attempts:
          type: integer
          description: 送信を試みた回数
        duplicate:
          type: boolean
          description: 対象設問がすべて既存で新規作成がなかった場合はtrue
        reason:
          type: string
          description: skipped時の理由
        errorMessage:
          type: string
          description: failed時のエラー内容
